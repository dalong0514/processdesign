## 01. 需求收集

## 02. 意见收集

### 2020-08-04

章圣望：

1、储罐块的基点偏移。——已完成

新版的块复制到含有旧版块图纸里，块里的部分图形（比如储罐块中间的横线），会偏移出去。回复：后来发现是因为储罐块的基点位置偏了导致的，重新定义一下块即可。

解决方法：从经典模式切换到三维建模模式，「插入」面板下面有一个「管理属性」，点右上角的「同步」按钮即可。进入「管理属性」的命令是「BATTMAN」。

### 2020-08-06

曾函卫：

1、如何在老的流程图里使用新版的块。——已完成

已验证过的方法：直接把老版图纸整体拷进新版插件里，这样的话块属性是以新版插件里的块为准的，然后再进入「管理属性」里进行同步。这样的话，老版块里原来没有的「工作介质」字段也会更新进来，太赞了！

张堃：

2、仪表的属性里增加型号字段。——已完成

远传仪表，例如液位计，就有雷达，磁翻板，液位开关等多种类型，但是在流程图里只有 LI 一种表示表示方法，而实际过程中，有些位置是需要制定类型液位计的。流量计也是如此，楔形、质量、旋涡等等，也都有特定使用工艺，所以我建议在远传仪表的属性里增加种类这一项，既可以方便业主审核，也可方便工艺自查。

### 2020-08-11

徐骋：

1、管道号属性和仪表属性增加图号。——已完成

2、区域覆盖。选中区域覆盖，右键点进入「绘图次序」后点「后置」。——已完成

3、管道号属性里的，那根横线放进管道号备注图层里去。——已完成

4、选中图形后，find 快捷键，可以批量改属性里的值，同时勾选「取消隐藏」属性。——已完成（技巧）

张坤：

5、增加一个自定义的设备块。——已完成

### 2020-08-18

林俊：

1、仪表属性块增加 SIS 块。

### 2020-08-20

徐骋：

1、仪表控制点名称自动拼接。

2、保温材料只要有一个填好，其余自动填充。

3、设备块，工作介质外显。

## 03. 修改记录及 bug

1、cad 的上标字符「\U+00B」导致数据的读取有问题。——已修复

解决方案：在预处理函数里剔除掉。

```php
/**
 * 读取 cad 数据后的清洗
 * 去除 bom
 * json 数据解码
*/
private function preProcess(&$item, $key) {
    // 剔除 bom
    $item=ltrim($item, "\XEF\XBB\XBF");
    // 以后改用正则，使用范围更广
    $item = str_replace("\r\n", "", $item);
    $item = str_replace("\U+2205", "∅", $item);  // 替换 cad 里直径字符
    $item = str_replace("\U+00B", "", $item);  // 剔除立方等上标 cad 字符
    $item = json_decode($item, true);
}
```

2、修复设备块的基点位置错误，偏移图形太远。——已修复

贡献者：张堃。

3、cad 的字符「\U+008C」、「\U+008D」导致数据的读取有问题。解决方法同 bug-1。——已修复

贡献者：牟苏嫣、张坤。

### 版本 V0.4

1、换热器，「换热元件规格」几个字不用自己写。

## 04. 邮件记录

### 2020-08-03

外管条件上线-升版V0.3

各位：

附件为升版后 V0.3 的相关属性块及其插件。V0.3 版本的更新说明如下：

1、新增外管条件（贡献者郑重、沈琦）。已跟外管对接，接受附件里自动生成的 Excel 版的外管条件。有点着重说明，外管去向里必须包含「去」或者「自」这 2 个字符，后台是根据这 2 个字符判断起点或终点的。

使用数据流提外管条件，目前可以为你节省时间的地方：1）设计温度、设计压力自动计算；2）管道直径根据管道号信息自动提取。3）流速，根据流量及提取出的管径自动计算；4）管道材质根据管道编号信息自动填充；5）管道保温代号、厚度信息，根据管道编号自动提取。

使用过程中有任何问题可随时与我联系。

### 2020-08-22

管道数据表及仪表块自动关联数据-升版V0.4

各位：
 
附件为升版后 V0.4 的相关属性块、插件以及配套的材料等级表。V0.4 版本更新内容比较多，请大家耐心阅读一下。
 
01.更新内容
 
管道数据表相关：
 
1、新增管道数据表模块。
 
抽出来的管道数据，在设计流数据一体化平台上可以导出 2 个文件，一个是我们的成品管道数据表，一个是做管段表用的数据源（可导入公司做管段表的软件里用于统计材料）。
 
特别强调的是：管道等级号必须使用配套的材料等级表（附件）。只有使用配套的等级号，压力等级、吹洗介质、无损检测比例、检测合格等级、泄露性试验介质、压力，这几个数据后台可以自动根据相关逻辑判断填充，否则只能在导出的数据表内自行修改。
 
另：如果你项目里用到的物质在配套等级表里找不到相应的等级号，请与我联系。
 
仪表条件相关：
 
1、仪表数据与管道块、设备块数据关联。（贡献者冯大龙、顾川川、徐骋、蒋万忠）
 
仪表块、管道块和设备块内有相同的数据可以共用，减少重复输入。这个想法包括我自己在内，有多位同事想到并给我提了建议，目前已实现。
 
仪表块的中工作介质、温度、压力、所在位置的材质、所在位置的规格尺寸，这 5 个属性数据的提取逻辑如下：1）先判断仪表块里该属性有没有填，填了的话直接提取该数值。2）没填的话，后台会根据仪表块里的管道编号或设备位号，自动关联到对应的管道块或设备块，提取相应的数据。
 
简单说，如果管道块和设备块那边已经有了这 5 个属性数据，仪表块里只要在「LOCATION」这个属性里填上管道编号或设备位号，那 5 个数据可以不填了。
 
2、仪表属性块增加型号字段（贡献者张堃）
 
远传仪表，例如液位计，有雷达，磁翻板，液位开关等多种类型，但是在流程图里只有 LI 一种表示方法。而实际过程中，有些位置是需要判断液位计类型的。流量计同理，楔形、质量、旋涡等，也都有特定使用工艺。仪表属性块增加种类这一项，既可以方便业主审核，也可方便工艺自查。
 
3、仪表属性块增加图号字段。
 
4、集中仪表块新增区域覆盖。（贡献者徐骋）
 
流量计放在管道多段线上可直接覆盖底部管道，方便位置拖拽。
 
设备一览表相关：
 
1、新增了一个「自定义」设备块。（贡献者张坤）
 
如果设备不属于反应釜、储罐、换热器、输送泵、真空泵、离心机，可以使用这个块。
 
2、定型设备新增工作介质、温度、压力。输送泵、真空泵、离心机也新增这些属性，便于与仪表块数据关联用。
 
02.bug 修复记录
 
1、储罐块的基点偏移问题。（bug贡献者张堃）
 
上一版本V0.3 中，储罐设备块的基点位置有误，已修复。
 
2、cad 内特殊字符 \U+00B 等，导致数据读取失败。（bug贡献者牟苏嫣、张坤）
 
03.技巧汇总
 
1、保留老版流程图数据的前提下，使用新版的属性块。
 
目前验证过最保险的办法：1）将老版图纸整体拷进新版属性块模板（附件）里。2）命令「BATTMAN」进入块属性管理器。2）选中新版更新后的块，点击右上角的「同步」按钮。完成上面 3 步后你流程图里的老块会自动更新为新版块，同时老版里的数据都在。最后用新版插件自动提取相关数据即可。
 
2、管道号的箭头翻转。（贡献者徐骋、蔡翠平）
 
管道块的箭头，已经做成了可翻转块，单击一下小箭头可翻转。
 
3、批量增加图号。（贡献者徐骋）
 
仪表块和管道块是可以批量增加图号的。以仪表块为例，在 CAD 图层里关闭除了「仪表编号」的其他图层，选中该张图纸的所有仪表块，进入「特性面板」后把图号填进去。
 
4、批量修改块内的属性值。（贡献者徐骋）
 
批量选中自己想要修改的块后，find 快捷键进入查找替换面板，勾选「取消隐藏」属性后，可以批量修改替换块属性的值。
 
最后，使用过程中有任何问题可随时与我联系。
