# 0001. 交流记录

## 20200516戴强交流

1、分支的命令约定。

2、服务器上只有 master 分支，而且服务器上只能 pull，必须保证服务器的「干净」。

3、分支管理还是使用图形界面方便。在 VS Code 里用 GitLens 管理。

4、不走 http 请求。网页会超时，不走 http 请求的好处是，当脚本运行时长很长的话（比如导数据），就没关系，因为没延时。导数据的时候用这种方式。戴强用 PHP 做数据清洗的时候用这种工具的。

5、处理完逻辑 logic 后会得到一个 info 信息。这个逻辑不能写在控制器里，控制器只做 2 个事情，一个是获取参数，一个是验证参数，最后是返回，控制器约定只做这 2 个功能。控制器是永远就那么几行，一个方法是一个接口。业务逻辑都写到逻辑层（服务层）那边去。

6、laravel 很重的。从入口进去，自动加载、框架启动、处理、发出消息......整套下来的话，需要 100ms，再加上自己的逻辑处理，加起来做的接口起码要 300-400ms，这是一个请求的过程。Java 就很好，就一个架包启动，java 写的接口基本上都能控制在 100ms 以内。

## 20200524戴强交流

1、以业务为单元模块。比如管理员登录、比如项目城市信息查询等。

2、自动组装 json 格式，然后返回 json 格式数据。在全局变量里去捕获（相当于把组装数据格式抽象一层封装起来。）

3、原始 laravel 的问题是，一个文件对应一个接口，接口很多的话话那么文件就很多了。现在的是一个方法对应一个接口。

4、本项目框架的实用性。针对的业务场景，一个用户模型可以用一个 controller 搞定的，比如管理员相关的行为用一个 AdminController.php 可以搞定的，像戴强他们公司里的项目，一个管理员相关的行为是当一个项目来做的，这种项目的话本框架就不适合了。再比如他最近在用 java 写的那个搜索功能，4 个人做，这个功能就当作项目来做的。现在这种框架结构的控制器里就很干净。

5、laravel 里多用 dd() 函数，哈哈。

RoomController.php

```php
<?php
/**
 * Created by Dingo.
 * Date: 2020/5/16
 * Time: 00:19
 *
 * Admin文件夹作为对内服务的api
 * 所有的controller 继承这个Controller基类
 * Admin的公共逻辑写在这里
 */

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller as BaseController;
use App\Http\Requests\RoomRequest;
use App\Logic\RoomLogic;

class RoomController extends BaseController
{
    private $roomLogic;
    private $roomRequest;

    public function __construct(RoomRequest $request)
    {
        $this->roomLogic = new RoomLogic();
        $this->roomRequest = $request;
    }

    /**
     * 上传房间数据
     * @url /admin/room/upload
     */
    public function upload()
    {
        $source = $this->roomRequest->file('source');

        if (!$source || !$source->isValid()) {
            return $this->error(1001, '文件无效');
        }

        if (!in_array($source->getClientOriginalExtension(), ['csv', 'xls'])) {
            return $this->error(1001, '只接收csv，xls文件');
        }

        return $this->roomLogic->upload($source);
    }

    /**
     * 数据确认，数据保存
     * @url /admin/room/save
     */
    public function save()
    {
        $sourceData = $this->roomRequest->post('source_data');
        $monomerId = $this->roomRequest->post('monomer_id');
        $res = $this->roomLogic->save($sourceData, $monomerId);
        return $res;
    }

    /**
     * 获取房间数据
     */
    public function list()
    {
        $param = $this->roomRequest->all();

        return $this->roomLogic->list($param);
    }

    /**
     * 项目号加单体号列表
     */
    public function projectMonomer()
    {
        return $this->roomLogic->projectMonomerList();
    }

}
```

RoomLogic.php

```php
<?php
/**
 * Created by Dingo.
 * Date: 2020/5/16
 * Time: 10:13
 */

namespace App\Logic;

use App\Exceptions\LogicExceptions;
use App\Model\EquipmentModel;
use App\Model\Imports\CadVentilateImport;
use App\Model\PropertyModel;
use App\Model\RoomModel;
use App\Model\SubstanceModel;
use Illuminate\Support\Facades\Schema;
use Maatwebsite\Excel\Facades\Excel;
use PhpParser\Node\Expr\Cast\Object_;

class RoomLogic extends BaseLogic
{

    /**
     * 上传文件，处理数据
     * @param object
     * @throws
     * @return mixed
     */
    public function upload($source)
    {
        $collection = Excel::toArray(new CadVentilateImport(), $source);

        if (!$collection) {
            $this->error('文件不能为空');
        }

        $collection = $collection[0];
        $sourceKey = $collection[0];
        $sourceKey = array_slice($sourceKey, 2);

        array_shift($collection);
        $collection = array_merge($collection);

        foreach ($sourceKey as &$key) {
            $key = mb_strtolower($key);
        }
        foreach ($collection as &$value) {
            $value = array_slice($value, 2);
            $value = array_combine($sourceKey, $value);
        }

        // 数据整理
        $roomColumn = Schema::getColumnListing('room');
        $equipmentColumn = Schema::getColumnListing('equipment');
        $substanceColumn = Schema::getColumnListing('substance');
        $roomList = [];
        $equipmentList = [];
        $substanceList = [];
        foreach ($collection as $datum) {
            foreach ($datum as $key => $item) {
                if ($item !== null && in_array($key, $roomColumn)) {
                    $roomList[$datum['room_num']][$key] = $item;
                }

                if ($item !== null && in_array($key, $equipmentColumn)) {
                    $equipmentList[$datum['room_num']][$datum['equipment_num']][$key] = $item;
                }

                if ($item !== null && in_array($key, $substanceColumn)) {
                    $substanceList[$datum['room_num']][$datum['substance_name']][$key] = $item;
                }
            }
        }

        $equipmentListData = [];
        foreach ($equipmentList as $item) {
            $equipmentListData = array_merge(array_values($item), $equipmentListData);
        }
        $substanceListData = [];
        foreach ($substanceList as $item) {
            $substanceListData = array_merge(array_values($item), $substanceListData);
        }

        return [
            'room' => array_values($roomList),
            'equipment' =>  array_merge(array_filter($equipmentListData, function ($row) {
                if (count($row) > 1) {
                    return true;
                }
            })),
            'substance' => array_merge(array_filter($substanceListData, function ($row) {
                if (count($row) > 1) {
                    return true;
                }
            })),
        ];
    }

    /**
     * 保存数据
     * @param string
     * @param string
     * @thow
     * @throws
     * @return mixed
     */
    public function save($sourceData, $monomerId)
    {
        $sourceData = json_decode($sourceData, true);

        if (!$sourceData) {
            $this->error('数据不能为空');
        }

        $roomList = $sourceData['room'];
        $roomIds = [];
        foreach ($roomList as &$value) {
            if (!isset($value['room_num']) || !$value['room_num'] ) {
                continue;
            }
            $room = $this->getRoomByNum($value['room_num'], $monomerId);

            $value['monomer_id'] = $monomerId;
            if ($room) {
                RoomModel::query()->where('id', $room->id)->update($value);
                $roomIds[] = $room->id;
            } else {
                $value['created_at'] = time();
                $value['updated_at'] = time();
                $roomIds[] = RoomModel::query()->insertGetId($value);
            }
        }

        EquipmentModel::query()->whereIn('room_id', $roomIds)->delete();
        $equipmentData = $sourceData['equipment'];
        foreach ($equipmentData as &$equipment) {
            $room = $this->getRoomByNum($equipment['room_num'], $monomerId);

            $equipment['room_id'] = $room->id;
            $equipment['type'] = array_search($equipment['type'], EquipmentModel::$type);
            EquipmentModel::query()->insert($equipment);
        }

        SubstanceModel::query()->whereIn('room_id', $roomIds)->delete();
        $substanceData = $sourceData['substance'];
        foreach ($substanceData as &$substance) {
            $room = $this->getRoomByNum($substance['room_num'], $monomerId);
            $property = PropertyModel::query()->where('cname', 'like', '%' . $substance['substance_name'] . '%')->first();
            if ($property) {
                $substance['property_id'] = $property->id;
            }
            $substance['room_id'] = $room->id;
            SubstanceModel::query()->insert($substance);
        }

        return true;
    }

    /**
     * 根据房间编号查房间id
     * @return Object
     */
    public function getRoomByNum($roomNum, $monomerId)
    {
        $where = [
            'room_num' => $roomNum,
            'monomer_id' => $monomerId
        ];
        $room = RoomModel::query()
            ->where($where)
            ->first();
        return $room;
    }

    /**
     * 获取数据
     * @param array
     * @return mixed
     */
    public function list($param)
    {
        $where = [];
        $data = [];
        if (isset($param['room_num']) && $param['room_num'] !== null) {
            $where['room_num'] = $param['room_num'];
        }
        if (isset($param['monomer_id']) && $param['monomer_id'] !== null) {
            $where['monomer_id'] = $param['monomer_id'];
        }

        $data['room'] = RoomModel::query()->where($where)->get()->toArray();
        $data['substance'] = SubstanceModel::query()->whereIn('room_id', array_column($data['room'],'id'))->get()->toArray();
        $data['equipment'] = EquipmentModel::query()->whereIn('room_id', array_column($data['room'],'id'))->get()->toArray();
        return $data;
    }

    /**
     * 获取
     * @throw
     */
    public function projectMonomerList()
    {
        $list = RoomModel::query()->select(['project_id', 'monomer_id'])->get();

        $resList = [];
        foreach ($list as $value) {
            if (!$value['project_id'] || !$value['monomer_id']) continue;
            $resList[] = $value['project_id'] . '-' . $value['monomer_id'];
        }
        return $resList;
    }

    /**
     * 房间参数、房间通风
     * @throws
     * @return mixed
     */
    public function roomVentilate($roomId)
    {
        $room = RoomModel::query()->find($roomId);

        if (!$room) {
            $this->error('房间不存在', 1001);
        }

        try {
            $city = $room->load(['monomer.project.city'])->monomer->project->city;
        } catch (LogicExceptions $exception) {
            $this->error('无法查询城市信息', 1001);
        }

        $data = [
            'explosion_air' => ExplosionAirLogic::build($room)->explosionAir(),  // 防爆通风风量
            'clear_harm' => ClearHarmLogic::build($room)->clearHarm(),  // 消除有害物质
            'clear_wet' => ClearWetLogic::build($room)->clearWet(),  // 余湿
            'clear_hot' => ClearHotLogic::build($room)->clearHot(),  // 余热
            'summer_d' => VentilationLogic::build($room)->summerD(),  // 夏季绝对湿度
            'winter_d' => VentilationLogic::build($room)->winterD(),  // 冬季绝对湿度
            'out_summer_d' => VentilationLogic::build($city)->summerD(), // 室外夏季绝对湿度
            'out_winter_d' => VentilationLogic::build($city)->winterD(),  // 室外冬季绝对湿度
            'room_height' => $room['calculate_height'],
            'room_area' => $room['calculate_volume'],
        ];
        return $data;
    }

}
```