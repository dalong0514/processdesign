## 01. 需求建议收集

### 2020-05-02



## 02. 修改记录及 bug

1、仪表所在位置材质，没有优先使用自己填的「值」。

贡献者雷华杰。（2021-06-02）

2、仪表所在位置的尺寸，也没有优先使用自己填的「值」。

帮周星导仪表条件时，自己无意发现的。解决办法目前都是加 if 语句，很丑，以后重构。（2021-06-08）

```php
    /**
     * 补充关联管道的材质及尺寸
     * 已完成单元测试
     * refactored at 2021-04-22
     * refactored at 2021-06-01
     * refactored at 2021-06-08 材质和尺寸空值的时候才去匹配
    */
    public function complementPipeMaterialSize(&$item) {
        $pipeClass = $this->pipeDataUtils->getPipeClass($item['pipenum']);
        if ($item['material'] === '')
            $item['material'] = $this->pipeDataUtils->getPipeMaterialV2($pipeClass);
        if ($item['installsize'] === '')
            $item['installsize'] = $this->pipeDataUtils->getPipeCode($item['pipenum']);
    }
```

```php
    /**
     * 关联设备、管道的属性
     * refactored at 2020-12-28
     * refactored at 2021-04-23
     * refactored at 2021-06-08 材质和尺寸空值的时候才去匹配
    */
    public function linkProperty(&$item, $key) {
        $pipeId = $this->pipeDataUtils->getPipeId($item['location']);
        $linkedProperties = ['temp', 'pressure', 'substance', 'phase'];
        foreach ($linkedProperties as $property) {
            if ($item[$property] == '') 
                $item[$property] = $this->getValueByTwoIndex($this->processedEquipPipeData, $pipeId, $property);
        }
        // 关联管道的保温材料
        $linkedPipeNum = $this->getValueByTwoIndex($this->processedEquipPipeData, $pipeId, 'pipenum');
        // 关联材质 2021-04-22
        // refactored at 2021-06-02
        if ($item['pipeclasschange'] === '') {
            if ($item['material'] === '')
                $item['material'] = $this->getValueByTwoIndex($this->processedEquipPipeData, $pipeId, 'material');
            if ($item['installsize'] === '')
                $item['installsize'] = $this->getValueByTwoIndex($this->processedEquipPipeData, $pipeId, 'installsize');
        }
        if ($item['pipeclasschange'] !== '') {
            $pipechangedClass = $this->getChangedPipeClass($linkedPipeNum, $item['pipeclasschange']);
            if ($item['material'] === '')
                $item['material'] = $this->pipeDataUtils->getPipeMaterialV2($pipechangedClass);
            $linkedPipeNum = $this->replacePipeClassChange($linkedPipeNum, $pipechangedClass);
            if ($item['installsize'] === '')
                $item['installsize'] = $this->pipeDataUtils->getPipeCode($linkedPipeNum);
        }
        // red hat update the changed diameter info 2021-05-11
        if ($item['reducerinfo'] !== '') {
            $pipechangedDiameter = $this->getChangedPipeDiameter($linkedPipeNum, $item['reducerinfo']);
            $linkedPipeNum = $this->replacePipeDiameter($linkedPipeNum, $pipechangedDiameter);
            if ($item['installsize'] === '')
                $item['installsize'] = $this->pipeDataUtils->getPipeCode($linkedPipeNum);
        }
        // red hat - miss the origin comment value 2021-05-11
        if ($this->pipeDataUtils->getInsulationCode($linkedPipeNum)) 
            $item['comment'] = '保温厚度' . $this->pipeDataUtils->getInsulationThick($linkedPipeNum) . 'mm；' . $item['comment'];
        // 更新所在仪表所在位置的管道数据
        if ($this->ksDataUtils->isInstrumentLocationOnPipe($item['location'])) 
            $item['location'] = $linkedPipeNum;
    }
```


## 03. 暖通记录及 bug


## 04. 邮件记录

### 2021-05-10
