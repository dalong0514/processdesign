## 01. 需求收集

## 02. 建议收集

### 2020-03-02

1、通过启动文件来加载 `dataflow.lsp` 来启动数据流的插件。

2、技巧：图纸里块编辑器里直接改，改完本图纸同步一下。

### 2020-03-08

1、已有的数据流模块自动生成。

2、重构批量刷起点和终点；批量刷管道起点；批量刷管道终点。—— 已完成

3、重构刷仪表所在位置。—— 已完成

### 2020-03-30

1、生成的外管块没有关联管道的数据 ID。

2、生成的仪表块和管道块，自动更新仪表所在位置以及管道的起点。

### 2020-03-31

1、仪表里无需填写的物性数据说明，写进说明文档里。

## 03. 修改记录及 bug

1、导出的管道数据进 PHP 处理后有空子项；管道数据表介质名称太长超出数据表字段最大值。

解决方案：剔除空子项。—— 已修复（V2.0）

贡献者：葛兰兰（2021-03-01）。

2、数据流插件自动启动。

总算解决了。把「总启动」的代码放到文件「dataflow.mnl」里。

```c
(defun s::startup ()
  (vl-load-all "D:\\dataflowcad\\dataflow.VLX")
)
(princ "\n数据流一体化开发者：冯大龙、谢雨东、华雷、曾涵卫、徐骋、郑飞宏、靳淳，版本号V2.0")
```

而且命令 `op` 一下，把 dataflow 的路径添加进去。

补充：发现有些人电脑里还是自动加载不了。（2021-03-16）

3、自动编号时有些管道匹配错误。—— 已修复（V2.0）

原来代码的逻辑，氮气 N 会匹配到乙二醇 NEGR，因为当时是按照通配符 `N*` 去匹配要自动编号的管道的。

贡献者：陈樟女（2021-03-01）。

```c
(defun GetPipeAndEquipChildrenDataListByNoDrawNum (propertyValueDictList dataType codeNameList / childrenData childrenDataList numberedList) 
  (foreach item codeNameList 
    (setq childrenData 
      (vl-remove-if-not '(lambda (x) 
                           ; sort data by codeName
                           ; red hat - bug - 氮气N 会匹配到乙二醇 NEGR - 2021-03-16
                          ;(wcmatch (cdr (assoc (car (numberedPropertyNameListStrategy dataType)) x)) (strcat item "*"))
                           (MatchDataBycodeName (cdr (assoc (car (numberedPropertyNameListStrategy dataType)) x)) item)
                        ) 
        propertyValueDictList
      ) 
    )
    (setq childrenDataList (append childrenDataList (list childrenData))) 
    (setq numberedList 
      (append numberedList (list (GetNumberedListByStartAndLengthUtils item "1" (length childrenData))))
    ) 
  )
  (list childrenDataList numberedList)
)

; 2021-03-16
(defun MatchDataBycodeName (pipeNum codeName /)
  (= (GetPipeCodeByPipeNum pipeNum) codeName)
)
```

4、自动生成非匹配「默认设备」图形失败。—— 已修复（V2.0）

2021-03-16

啥都没改竟然无法生成默认图形，找了好久是因为库里的图层「0DataFlow-GsBzEquipDefault」被清理了，「偷图层」包，找不到该图层。

```c
; red hat - 2021-03-16
(defun InsertBlockGsBzEquipGraphStrategy (insPt gsBzBlockName allGsBzEquipBlockNameList /) 
  (if (member gsBzBlockName allGsBzEquipBlockNameList) 
    (InsertBlockUtils insPt gsBzBlockName "0DataFlow-GsBzEquip" (list (cons 0 (GetGsBzEquipTypeClass gsBzBlockName)) 
                                                                  (cons 4 (GetGsBzEquipType gsBzBlockName))
                                                                ))
    ; if has no layer [0DataFlow-GsBzEquipDefault], do not generate graph, bug record - 2021-03-16
    (InsertBlockGsBzEquipDefault insPt (list (cons 0 (GetGsBzEquipTypeClass gsBzBlockName)) ))
  )
)
```

5、之前修复陈樟女的那个 bug 导致了设备无法自动编号。

贡献者：宗源（2021-03-22）。

解决方案：管道匹配的逻辑和设备匹配逻辑不同导致的。将 2 个逻辑用策略模式抽象出来。详见源码。

6、自动生成的辅助流程没字。

贡献者：李侦糠（2021-03-22）。

原因：CAD 里没有 dataflow 这个字体。

解决方案：需要字体的功能之前，加一行「偷字体」的代码。之前做暖通设备一览表的时候这个「偷字体」的功能已经封装好了的。直接调用。

7、仪表按设备位号编号匹配不了 04C-V1101 这种设备位号。—— 已修复（V2.1）

贡献者：宗源（2021-03-29）。

8、仪表按设备位号编号报错。—— 已修复（V2.1）

自己发现的这个 bug，报错信息：

```
; 错误: 非选择性的参数 autolisp
```

还好可以自己只选 2 个仪表编号一步步调试找错。最后定位到管道上的仪表其所在位置的管道号是错的，图里没那根管道，导致以这个管道号去匹配图纸里来去向的数据找到到，返回的是 nil，导致后面没法进行下去了。由此深刻体会到需要时刻有根弦，函数返回的是 nil 的话如何去处理。错误代码位置：

```c
; 2021-01-26
(defun GetNewEquipTagLocation (oneKsDataOnPipe pipeFromAndToDictList equipPositionDictList / pipeLine pipeFromToPair)
  (setq pipeLine (GetPipeLineByPipeNum (cdr (assoc "LOCATION" oneKsDataOnPipe))))
  
  (setq pipeFromToPair (cdr (assoc pipeLine pipeFromAndToDictList)))
  (if (/= pipeFromToPair nil) 
    (GetEquipTagLinkedPipe (car pipeFromToPair) (cadr pipeFromToPair) oneKsDataOnPipe equipPositionDictList)
  )
)
```

9、变管径信息无法增加新观点。—— 已修复（V2.1）

整理汇报时发现的这个 bug。

PL1101-40-2J1，变径信息为 25x40 的有效，但 40x25 的无效。好在写了单元测试，比较容易定位到 bug。原因在于原有管径的信息是整数 40，变径信息分解成的数组为字符串，40x25 分解为 ['40', '25']，原来判断的逻辑基于 `!==` 考虑了数据类型，有误了。（2021-03-31）

```
    /**
     * 2020-12-23
     * red hat - refactored at 2021-03-31
    */
    public function getOtherItemForListUtils($oldItem, $sourceList) {
        if (in_array($oldItem, $sourceList)) {
            foreach ($sourceList as $item) {
                // 传进来的原管径是整数类型，而要比较的管径字符串，这里用 [!=] 而非 [!==]
                if ($item != $oldItem) return $item;
            }
        }
        return $oldItem;
    }
```

## 04. 邮件记录

### 2021-03-20

邮件名：设计流数据一体化升版V2.0

各位：

这次工艺设计流变动较大，而且数据正式从流程图流向设备布置图了，所以升了大版本。目前功能越来越多，月底我这边会开一个设计流软件使用的宣贯会，跟大家具体聊下使用的技巧和注意事项，具体时间以通知为准。附件为升版 V2.0 后的的相关文件，更新内容如下（具体操作详见说明文档）：

### V2.0 版更新内容

**总体相关：**

1、设计流所有组件封装到后台。

以后不用每次拷之前发布的模板 CAD 到自己的流程图里了，新建一个空白图纸也可以通过工具栏里的按钮生成管道、仪表、设备位号等属性块。

2、重新梳理了内网上的文档说明。

**布置图相关：**

1、流程图设备数据自动迁移到布置图。

目前流程图中的设备数据可以直接迁移到设备布置图里。一键生成对应的布置图设备位号，并根据设备尺寸匹配相应的「设备平面图形」。

备注：目前设备外形图形库只做了立式储罐以及 B 型支耳的搪玻璃反应釜（开式及闭式）。如果设备尺寸匹配不到相应的「设备平面图形」，而你手里又有比较好的设备图形，请提供给我。此功能的实现，需要大家一起把手里比较好的、厂家提供的设备外形图块放在一个公共图形库里。

2、设备布置图平面图形根据设备代号自动匹配更新。排方案后，如果设备尺寸修改后，可以根据「设备代号」自动更新其外形图形。

布置图中的设备数据也可以导出到临时 Excel 文件，通过更改「设备类型代号」可以更新设备的外形尺寸图形。

3、通过设备的临时 Excel 文件自动生成布置图里的设备位号以及设备的外形尺寸图形。

针对的场景：拿到业主的设备资料后，整理出需要的设备关键参数后，复制到临时 Excel 文件，可以直接在布置图里生成设备位号以及匹配的设备的外形尺寸图形。

4、迁移建筑底图到工艺设备布置图。

基本思路：1）自动抓取建筑图纸里特定的对象数据（柱子、墙、门、窗、楼梯）生成建筑底图，干净的建筑底图可以迁移到工艺设备布置图里。2）建筑底图的图层支持一键锁定和解锁。3）支持一键更新。建筑那边的图纸修改后可以更新到本专业底图。

**流程图相关：**

1、生成仪表块继承所在设备或所在管道的数据（贡献者王小飞、曾涵卫）。

除了常规的 copy 外，目前提供了另外一种画管道块和仪表块的方式。以设备为核心，生成设备上的仪表块可以继承设备的部分属性数据。生成从设备出去的管道也可以继承设备的部分属性数据。详见内网说明文档中的「流程相关说明」。

2、新增批量刷只刷管道起点或者只刷管道终点。

3、通过设备的临时 Excel 文件自动生成流程图的设备位号以及流程设备图形块。

针对的场景：拿到业主的设备资料后，整理出需要的设备关键参数后，复制到临时 Excel 文件，可以直接在流程图里生成设备位号以及匹配的设备图形（设备图形库还未上线）。

4、取消了每次导临时 Excel 文件前必须选择「预览修改」的限制。

### V2.0 版 bug 修复

1、自动编号时有些管道匹配错误。（bug 贡献者陈樟女）

物料代号 N（氮气）会匹配到 NEGR（乙二醇 ）。

2、仪表条件里液位的负值无法显示负号。（bug 贡献者牟苏嫣）

## 个人随笔

2021-03-03

1、点起点设备位置、终点设备位置，两个点去匹配距离最近的设备位号，自动生成折线，管道块自动插在最长的多段线上。

2、做一个自定义的多段线pl命令，用这个命名来化管线。画完管线后如何绑定管道号？

2021-03-04

1、生成管道和仪表可以用选择集选择2个数据源提取数据。仪表选一个设备（所在位置、其他共享属性）一个其他仪表（仪表位号）。管道选择一个设备和另外一个管道。

2、多段线拆解成多个直线数据：获取所有的位置点。去头形成一个数组，去尾形成一个数组，两数组中元素按顺序匹配成直线数据。

验证一个点是否在直线上：对于水平线，点的y坐标与直线y坐标相同（写一个约等于函数），点的x坐标在直线两个x坐标之间。

2021-03-05

1、工艺布置图里筛柱子时先剔除建筑图签。

2021-03-09

1、打开外部文件后，只要不释放，是不是意味着，图纸空间里已经生成了entity name，那么就可以直接通过handle获取entity name。

2、匹配不到的图形，用圆圈表示。这样让用户知道目前没有该类型库，可以与我联系。

2021-03-10

1、布置图的设备块，块名与流程图一样，修改临时文件的逻辑直接套用。

2、悬挂的设备，下层楼板的设备图形直接生成或更新。

3、布置图的设备图形块增加设备种类和体积。

2021-03-11

1、从csv读数据生成图形的改进，先形成位号块，根据位号块的的entity name过去属性点对数据，直接套用从流程图迁移数据的逻辑。这这种方式可以通过已经有属性名匹配。还有路径，读取出的csv先直接跟属性名形成点对数据集。

2、布置图设备代号所需的元素：设备类型、体积、直径，外加小类别，比如立式或挂耳。举例：GsBzTank- V1000D800LS。

3、建筑的轴线号的那个块不用自动生成，只是作为定格点。第一次自己拷轴线好到工艺的布置图中。

2021-03-12

1、借用布置图的思维。自动用临时文件生成流程图的设备位号和设备图形。

2、流程图和设备布置的信息匹配。左右两个界面：1）匹配到流程比布置多的数据；直接选取插入点生成这些数据。2）匹配到流程比布置少的数据；直接定位到这些设备的位置；一键清空这些设备信息（待确认是否需要）。

3、让用户没法破坏生成的大积木的标签。直接从用户的图纸里提取他们修改后的「模式」。自下而上的让用户自己生产内容。

4、在已有设备数据信息的情况下，根据临时文件导入生产位号、图形，也做一个数量的匹配。

5、流程图生成管道块前赋值的逻辑改进。之前按块属性的序列号匹配的，但上一个版本做竖向管道块时，version属性顺序弄在了第二位，导致赋值错位。还是生成图形后直接获取其entity name，然后根据属性名来匹配赋值。

6、数据流的所有图层名前加一个0，比如0DataFlow-Instrument，这样弄保证设计流的图层都在图层管理器顶部。—— 已完成

7、把数据导成csv存在本地，作为一个数据库用。

2021-03-13

1、设计流使用的流程（作业系统），做一个系统。

2、设备布置里设备图形块新增层高、外形尺寸（待确定）字段。

3、匹配不到的设备图形块，包括中心线所有图形单独放到那个设备图层里，方便全部隐藏掉。

4、输入积木关系的信息放在CAD实现，而且结合弹窗。两大类命令，生成积木的命令和修改积木的命令。修改积木的命令可以抽象成一个按钮，通过选择集选择的不同类型块匹配到去修改哪个积木界面。

比如母体积木。新建一个母体积木。点修改按钮选择该母体，弹出母体信息输入界面，比如需要的冷媒下来列表、需要的热媒下来列表、需要陪冷凝器的选项（而且可以选择不同的冷凝器形式）等等。

比如管道积木，先选择母体进行绑定后生成管道积木，一个积木里可以容纳多跟实际管道。分开的两个积木管道代表接入设备的两个接口。

补充：进口管积木、气相出口管积木，是母体积木的二级积分，以此实现多级嵌套。

补充：面板里收集的信息绑在母体的Xdata上，这样用户只能通过面板修改。

补充：积木区域可以固定在流程图图签固定位置，自动在该图签所在图框内生成。

2021-03-15

1、自动更新管道来源；自动更新仪表所在位置。

2021-03-16

1、生成的积木，里面的元素打个标签。随便选一个元素拾取该标签，然后可以整体移动该积木。

2021-03-17

1、管子超了2000因为处理超时导致导不出仪表条件。可以把匹配逻辑放到CAD端，这样也只需导出仪表数据。2021-03-18

1、直接把 excel 界面做前端界面。

做开发暖通设备表，实现了从 excel 里提取 csv 文件，那么反向操作。CAD 提取的数据我可以只用在 excel 用 VBA 提取本地的csv文件，通过 VBA 写输入进设备一览表模板里。exce 里添加几个「按钮」说白了跟前端界面就是一样的了。

2021-03-18

1、复杂和很多图像的数据，先打标签，然后打包成块。通过「偷」跨图，然后接上宏「炸开」，炸开后的各个实体对象因为有了标签，如何操作可以实现了。待验证是否可行。

2、写一个增加Xdata的界面版命令！方便打标签。

2021-03-19

1、跟夏老板聊天，确定了是生成图形而非匹配图形。

2021-03-21

1、建筑底图的轴线号直接用「复制宏」来挪移。—— 已完成