## 01. 条件渲染

```js
export default ({value, onOk, disabled}: {value?: string, onOk: Function, disabled?: boolean}) => {
  
  let handleClick = async () => {
    if(disabled) {
      message.warn('不支持编辑地址')
      return
    }
    
    let dir = await SystemSelector.selectSystemDir(value) 

    onOk?.(dir)
  }
  
  return (
    <div onClick={handleClick} className={styles.container}>
      {
        value ? 
        <Tooltip title={value} mouseEnterDelay={2}>
          <span>{value}</span>
        </Tooltip> : <span>请选择文件夹</span>
      }

      <i className="iconfont hlj-mululan-wenjianjia-guanbi"/>
    </div>
  )
}
```

## 02. HTTP 请求

2021-05-17

墨菲的一个写法：

```js
    const { code, data } = await nsApi.postCalculate({ // 通过修改的参数来重新请求这一行的数据
      params: {
        // 参数
        
      }
    })
```

## 03. 洁净空调mok

2021-05-17

初版，房间数据更新后组件无法自动渲染，源码如下。

app/src/pages/NsCleanCondition/Store.ts

```js
import { action, observable } from 'mobx'
import { nsApi } from '@api'

export default class {
  @observable showTable = false
  @observable roomData: Map<string, any[]> = new Map()
  @observable sysData: Map<string, any[]> = new Map()

  @action
  getGsCleanAirAxios = async (values) => {
    const { projectNum, monomerNum } = values

    const { code, data } = await nsApi.getGsCleanAir({
      params: {
        project_num: projectNum,
        monomer_num: monomerNum,
        model: 'ns_clean_air',
      }
    })

    if (code === 20000) {
      const { roomData, sysData } = data

      this.roomData = new Map(Object.entries(roomData))
      this.sysData = new Map(Object.entries(sysData))
      this.showTable = true
    }
  }

  @action
  changeRoomRowData = async (inputValue, index: number, tab: string) => {
    const row = this.roomData.get(tab)

    if (!row || !row[index]) return

    row[index]['roomSupplyAirInletNum'] = inputValue.target.value
    // console.log(row[index])
    const { code, data } = await nsApi.postCalculate(row[index])
    
    if (code === 20000) {
      row[index] = data
      // this.roomData.set(tab, row)
      // console.log(this.roomData.get(tab))
    }

    // row[index]['roomSupplyAirInletNum'] = inputValue.target.value

    // 更新Map
    console.log(row[index])
    

    // console.log('row: ', row[index])
    // console.log('rowdata: ', inputValue.target.value)
  }
}
```

app/src/pages/NsCleanCondition/Components/DataTable/index.tsx

```js
import React from 'react'
import { observer } from "mobx-react"
import { Button, Form, Input, Table } from 'antd'
import styles from './styles.less'
import { roomDataCol, sysDataCol } from './columns'
import Store from '../../Store'
import { ColumnsType } from 'antd/lib/table'

interface IProps {
  roomList: any[]
  sysList: any[]
  store: Store
  tab: string
}

export default observer((props: IProps) => {
  const { roomList = [], sysList = [], store, tab } = props

  const roomColumns = roomDataCol(store, tab)

  return (
    <div className={styles.tableContainer}>
      <Table
        columns={sysDataCol}
        dataSource={sysList}
        scroll={{ y: 800, x: 800 }}
        pagination={{ hideOnSinglePage: true }}
        bordered />

      <Table
        columns={roomColumns as ColumnsType}
        dataSource={roomList}
        scroll={{ y: 800, x: 800 }}
        pagination={false}
        bordered />
    </div>
  )
})
```

实现后的新版源码如下。

app/src/pages/NsCleanCondition/Store.ts

```js
import { action, observable } from 'mobx'
import { nsApi } from '@api'

export default class {
  @observable showTable = false
  @observable roomData: Map<string, any[]> = new Map()
  @observable sysData: Map<string, any[]> = new Map()
  @observable roomDataFreshId = 0

  @action
  getGsCleanAirAxios = async (values) => {
    const { projectNum, monomerNum } = values

    const { code, data } = await nsApi.getGsCleanAir({
      params: {
        project_num: projectNum,
        monomer_num: monomerNum,
        model: 'ns_clean_air',
      }
    })

    if (code === 20000) {
      const { roomData, sysData } = data

      this.roomData = new Map(Object.entries(roomData))
      this.sysData = new Map(Object.entries(sysData))
      this.showTable = true
    }
  }

  @action
  changeRoomRowData = async (inputValue, index: number, tab: string) => {
    const row = this.roomData.get(tab)

    if (!row || !row[index]) return
    if (!inputValue.target.value) return // TODO 当输入为空或为0时，报错

    row[index]['roomSupplyAirInletNum'] = inputValue.target.value

    // console.log(row[index])
    const { code, data } = await nsApi.postCalculate(row[index])
    
    if (code === 20000) {
      row[index] = data
      // this.roomData.set(tab, row)
      // console.log(this.roomData.get(tab))
      this.roomDataFreshId = new Date().getTime()
    }

    // row[index]['roomSupplyAirInletNum'] = inputValue.target.value

    // 更新Map
    console.log(row[index]['roomSupplyAirInletTag'])
    

    // console.log('row: ', row[index])
    // console.log('rowdata: ', inputValue.target.value)
  }
}
```

app/src/pages/NsCleanCondition/Components/DataTable/index.tsx

```js
import React, { useEffect, useState } from 'react'
import { observer } from "mobx-react"
import { roomDataCol, sysDataCol } from './columns'
import { ColumnsType } from 'antd/lib/table'
import { cloneDeep } from 'lodash'
import { Table } from 'antd'
import Store from '../../Store'
import styles from './styles.less'

interface IProps {
  roomList: any[]
  sysList: any[]
  store: Store
  tab: string
}

export default observer((props: IProps) => {
  const { store, tab } = props
  const roomColumns = roomDataCol(store, tab)
  const sysList = store.sysData.get(tab)
  const [roomList, setRoomList] = useState(store.roomData.get(tab))

  useEffect(() => {
    const roomList = cloneDeep(store.roomData.get(tab))
    setRoomList(roomList)
  }, [store, store.roomDataFreshId, tab])


  return (
    <div className={styles.tableContainer}>
      <Table
        columns={sysDataCol}
        dataSource={sysList}
        scroll={{ y: 800, x: 800 }}
        pagination={{ hideOnSinglePage: true }}
        bordered />

      <Table
        columns={roomColumns as ColumnsType}
        dataSource={roomList}
        scroll={{ y: 800, x: 800 }}
        pagination={false}
        bordered />
    </div>
  )
})
```

墨菲的解释：Map是做数据管理的，不能被监听到。要用这里面的数据需要手动通过 get 属性去拿。

目前的理解：所以墨菲靠加一个 roomDataFreshId，通过它的变动去执行「更新」map 数据的操作。实现语句是这里是吧：`const roomList = cloneDeep(store.roomData.get(tab))`。
