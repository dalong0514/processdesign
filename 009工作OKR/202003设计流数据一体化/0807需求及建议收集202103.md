## 00. 个人随笔

2021-03-03

1、点起点设备位置、终点设备位置，两个点去匹配距离最近的设备位号，自动生成折线，管道块自动插在最长的多段线上。

2、做一个自定义的多段线pl命令，用这个命名来化管线。画完管线后如何绑定管道号？

2021-03-04

1、生成管道和仪表可以用选择集选择2个数据源提取数据。仪表选一个设备（所在位置、其他共享属性）一个其他仪表（仪表位号）。管道选择一个设备和另外一个管道。

2、多段线拆解成多个直线数据：获取所有的位置点。去头形成一个数组，去尾形成一个数组，两数组中元素按顺序匹配成直线数据。

验证一个点是否在直线上：对于水平线，点的y坐标与直线y坐标相同（写一个约等于函数），点的x坐标在直线两个x坐标之间。

2021-03-05

1、工艺布置图里筛柱子时先剔除建筑图签。

2021-03-09

1、打开外部文件后，只要不释放，是不是意味着，图纸空间里已经生成了entity name，那么就可以直接通过handle获取entity name。

2、匹配不到的图形，用圆圈表示。这样让用户知道目前没有该类型库，可以与我联系。

2021-03-10

1、布置图的设备块，块名与流程图一样，修改临时文件的逻辑直接套用。

2、悬挂的设备，下层楼板的设备图形直接生成或更新。

3、布置图的设备图形块增加设备种类和体积。

2021-03-11

1、从csv读数据生成图形的改进，先形成位号块，根据位号块的的entity name过去属性点对数据，直接套用从流程图迁移数据的逻辑。这这种方式可以通过已经有属性名匹配。还有路径，读取出的csv先直接跟属性名形成点对数据集。

2、布置图设备代号所需的元素：设备类型、体积、直径，外加小类别，比如立式或挂耳。举例：GsBzTank- V1000D800LS。

3、建筑的轴线号的那个块不用自动生成，只是作为定格点。第一次自己拷轴线好到工艺的布置图中。

2021-03-12

1、借用布置图的思维。自动用临时文件生成流程图的设备位号和设备图形。

2、流程图和设备布置的信息匹配。左右两个界面：1）匹配到流程比布置多的数据；直接选取插入点生成这些数据。2）匹配到流程比布置少的数据；直接定位到这些设备的位置；一键清空这些设备信息（待确认是否需要）。

3、让用户没法破坏生成的大积木的标签。直接从用户的图纸里提取他们修改后的「模式」。自下而上的让用户自己生产内容。

4、在已有设备数据信息的情况下，根据临时文件导入生产位号、图形，也做一个数量的匹配。

5、流程图生成管道块前赋值的逻辑改进。之前按块属性的序列号匹配的，但上一个版本做竖向管道块时，version属性顺序弄在了第二位，导致赋值错位。还是生成图形后直接获取其entity name，然后根据属性名来匹配赋值。

6、数据流的所有图层名前加一个0，比如0DataFlow-Instrument，这样弄保证设计流的图层都在图层管理器顶部。—— 已完成

## 01. 需求收集

## 02. 建议收集

### 2020-03-02

1、通过启动文件来加载 `dataflow.lsp` 来启动数据流的插件。

2、技巧：图纸里块编辑器里直接改，改完本图纸同步一下。

### 2020-03-08

1、已有的数据流模块自动生成。

2、重构批量刷起点和终点；批量刷管道起点；批量刷管道终点。

3、重构刷仪表所在位置。

## 03. 修改记录及 bug

1、导出的管道数据进 PHP 处理后有空子项；管道数据表介质名称太长超出数据表字段最大值。

解决方案：剔除空子项。—— 已修复（V2.0）

贡献者：葛兰兰（2021-03-01）。

2、数据流插件自动启动。

总算解决了。把「总启动」的代码放到文件「dataflow.mnl」里。

```c
(defun s::startup ()
  (vl-load-all "D:\\dataflowcad\\dataflow.VLX")
)
(princ "\n数据流一体化开发者：冯大龙、谢雨东、华雷、曾涵卫、徐骋、郑飞宏、靳淳，版本号V2.0")
```

而且命令 `op` 一下，把 dataflow 的路径添加进去。

## 04. 邮件记录
