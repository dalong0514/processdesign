# 0401. 开发记录202012

## 20201201

1、把提取各个仪表数据库表单数据的逻辑，做成了策略模式。

主要涉及到的函数 `getGsInstrumentpByMonomerNum`。

2、提取那个数据生成临时的 csv 文件，重构成了自己喜欢的映射函数批处理数组。

3、数组数据导出成 csv 文件，并以流文件的形式传递给前端。

```php
protected static function ExportCsvFile($data) {
    header('Content-Type: application/csv');
    header('Content-Disposition: attachment; filename="kstemp.csv"');
    $output = fopen('php://output','w');
    // UTF8 csv 文件头前需添加 BOM，不然 window 打开会是乱码
    fwrite($output, chr(0xEF).chr(0xBB).chr(0xBF));
    // 数据内容
    foreach($data as $item) {
        fputcsv($output, $item);
    }
    fclose($output);
}
```

这个功能找了好久资料才算解决的，目前也不能说 100% 吃透，感觉之前无法实现的原因，关键点在于 `header('Content-Type: application/csv');`，说到底还是自己 HTTP 的知识欠缺。

4、csv 转数组。

```php
public function ConvertCsvToArray(&$item, $key) {
    // 剔除 bom
    $item = ltrim($item, "\XEF\XBB\XBF");
    $item = str_replace("\n", "", $item);
    $item = str_getcsv($item);
}
```

